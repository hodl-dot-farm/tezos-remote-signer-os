#!/bin/bash

# Copyright 2020 MIDLDEV OU, all right reserved. https://midl.dev

# inspired by https://gist.github.com/Apsu/5021255

# Set defaults if not provided by environment
CHECK_DELAY=${CHECK_DELAY:-5}
CHECK_IP=${CHECK_IP:-8.8.8.8}
PRIMARY_IF=${PRIMARY_IF:-eth0}
BACKUP_IF=${BACKUP_IF:-eth1}

set_def_route_to_primary() {
  # read gateway data from ip command
  PRIMARY_GW=$( ip -j -4 route list type unicast dev $PRIMARY_IF | jq -r '.[0].gateway')
  BACKUP_GW=$( ip -j -4 route list type unicast dev $BACKUP_IF | jq -r '.[0].gateway')
  ip r d default via "$PRIMARY_GW" dev "$PRIMARY_IF"
  ip r d default via "$BACKUP_GW" dev "$BACKUP_IF"
  ip r a default via "$PRIMARY_GW" dev "$PRIMARY_IF" metric 100
  ip r a default via "$BACKUP_GW" dev "$BACKUP_IF" metric 200
}

set_def_route_to_secondary() {
  # read gateway data from ip command
  PRIMARY_GW=$( ip -j -4 route list type unicast dev $PRIMARY_IF | jq -r '.[0].gateway')
  BACKUP_GW=$( ip -j -4 route list type unicast dev $BACKUP_IF | jq -r '.[0].gateway')
  ip r d default via "$PRIMARY_GW" dev "$PRIMARY_IF"
  ip r d default via "$BACKUP_GW" dev "$BACKUP_IF"
  ip r a default via "$PRIMARY_GW" dev "$PRIMARY_IF" metric 200
  ip r a default via "$BACKUP_GW" dev "$BACKUP_IF" metric 100
}

primary_if_ok() {
  # -c1 -w5: tries 5 times in 5 seconds, returns true if at least 1 succeeds
  ping -I "$PRIMARY_IF" -c1 -w5 "$CHECK_IP" &>/dev/null
}

# Compare arg with current default gateway interface for route to healthcheck IP
gateway_if() {
  [[ "$1" = "$(ip r g "$CHECK_IP" | sed -rn 's/^.*dev ([^ ]*).*$/\1/p')" ]]
}

set_def_route_to_primary

printf "===============\n"
printf "Route at script startup:\n"
ip r
printf "===============\n"

# Cycle healthcheck continuously with specified delay
while sleep "$CHECK_DELAY"
do
  if primary_if_ok
  then
    # Health check succeeded.
    # Are we using the backup?
    if gateway_if "$BACKUP_IF"
    then # Switch to primary
      printf "Primary interface is up. We are on the secondary interface, switching to primary.\n"
      set_def_route_to_primary
      printf "kill ssh for autossh to restart fresh connection immediately\n"
      pkill -e -f /usr/bin/ssh
    fi
  else
    printf "Health check failed, primary Internet connection down.\n"
    # Are we using the primary?
    if gateway_if "$PRIMARY_IF"
    then # Switch to backup
      printf "We are on the primary interface, switching to secondary.\n"
      set_def_route_to_secondary
      printf "kill ssh for autossh to restart fresh connection immediately\n"
      pkill -e -f /usr/bin/ssh
    fi
  fi
done

